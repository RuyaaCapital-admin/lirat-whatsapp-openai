# Liirat WhatsApp Assistant

This service powers the Liirat WhatsApp trading assistant. It receives inbound WhatsApp webhooks, routes them through the OpenAI tool-call loop, and delivers answers back to users with Supabase-backed conversation memory.

## Required environment variables

Set the following variables in your deployment (e.g. Vercel):

- `SUPABASE_URL`
- `SUPABASE_SERVICE_ROLE_KEY`
- `WHATSAPP_TOKEN`
- `WHATSAPP_PHONE_NUMBER_ID`
- `OPENAI_API_KEY`
- `OPENAI_PROJECT`
- `VERIFY_TOKEN`

Optional variables:

- `OPENAI_MODEL` (defaults to `gpt-4o-mini`)
- `WHATSAPP_VERSION` (defaults to Meta's latest API version)

## Supabase schema

Create two tables to persist conversations:

### conversations

| column     | type      | notes                          |
|------------|-----------|--------------------------------|
| `id`       | uuid pk   | generated by Supabase          |
| `user_id`  | text      | WhatsApp phone number          |
| `tenant_id`| text      | use `default`                  |
| `title`    | text      | store the phone number or name |
| `created_at` | timestamptz | default `now()`              |

### messages

| column           | type      | notes                                           |
|------------------|-----------|-------------------------------------------------|
| `id`             | uuid pk   | generated by Supabase                           |
| `conversation_id`| uuid      | foreign key â†’ `conversations.id`                |
| `user_id`        | text      | WhatsApp number for user rows, "assistant" for bot |
| `role`           | text      | `user` or `assistant`                           |
| `content`        | text      | message body                                    |
| `created_at`     | timestamptz | default `now()`                                |

## Running tests

```bash
npm test
```

The test suite covers formatter helpers and webhook greeting logic.
